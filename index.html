<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PPC Inventory Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f7;
      color: #222;
    }
    h1, h2 {
      margin: 0 0 0.75rem;
    }
    h1 {
      font-size: 1.6rem;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 1.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1rem;
    }
    @media (min-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr) minmax(0, 2fr);
      }
    }
    .card {
      background: #fff;
      border-radius: 0.9rem;
      padding: 1rem 1.25rem 1.25rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.25rem 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid #d0d0d7;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #e0e0e6;
      padding: 0.25rem 0.35rem;
      text-align: right;
    }
    th {
      background: #fafafa;
      font-weight: 600;
      white-space: nowrap;
    }
    td:first-child, th:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: inherit;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      margin: 0.5rem 0 0;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 0.3rem;
    }
    .kpi-row {
      display: flex;
      justify-content: space-between;
      margin: 0.15rem 0;
      font-size: 0.85rem;
    }
    .kpi-label {
      color: #555;
    }
    .kpi-value {
      font-weight: 600;
    }
    .scroll-x {
      overflow-x: auto;
    }
    .tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <h1>PPC Inventory Model <span class="pill">Excel ‚Üí Web</span></h1>

  <div class="grid">
    <!-- Left: Parameters & Inputs -->
    <div class="card">
      <h2>Parameters</h2>
      <div id="params-container"></div>

      <h2 style="margin-top:1.5rem;">Inputs per SKU</h2>
      <div class="tag">Editable</div>
      <div class="scroll-x">
        <table id="inputs-table"></table>
      </div>

      <button class="btn" id="recalc-btn">
        üîÅ Recalculate
      </button>
    </div>

    <!-- Right: Outputs -->
    <div class="card">
      <h2>Per-SKU Calculations</h2>
      <div class="tag">Read-only, computed from Parameters & Inputs</div>
      <div class="scroll-x" style="max-height:300px;">
        <table id="calcs-table"></table>
      </div>

      <h2>KPIs</h2>
      <div id="kpis-container"></div>
    </div>
  </div>

  <script>
    /***********************
     * 1. Initial Data
     ***********************/

    const initialParams = [
      { id: "L", label: "Lead time L (weeks)", value: 2 },
      { id: "K", label: "Ordering cost K (currency/order)", value: 50 },
      { id: "sigmaL", label: "Lead time stdev param (weeks)", value: 0.5 },
      { id: "Lr", label: "Repl. lead time L_r (weeks)", value: 0.2 },
      { id: "kanbanSafety", label: "Kanban safety factor (fraction)", value: 0.1 },
      { id: "spaceCapacity", label: "Space capacity (volume units)", value: 4500 }
    ];

    // From your Inputs sheet (rows 2‚Äì13)
    let skuInputs = [
      { sku: "SKU01", mu: 80,         sigma: 20,    c: 13.11, h: 2.36, p: 39.33, v: 2.86, m: 25, L_override: "", K_override: "" },
      { sku: "SKU02", mu: 127.2727273, sigma: 31.82, c: 22.76, h: 4.10, p: 68.28, v: 1.88, m: 25, L_override: "", K_override: "" },
      { sku: "SKU03", mu: 174.5454545, sigma: 43.64, c: 7.21,  h: 1.30, p: 21.63, v: 0.64, m: 25, L_override: "", K_override: "" },
      { sku: "SKU04", mu: 221.8181818, sigma: 55.45, c: 4.57,  h: 0.82, p: 13.71, v: 2.63, m: 25, L_override: "", K_override: "" },
      { sku: "SKU05", mu: 269.0909091, sigma: 67.27, c: 19.23, h: 3.46, p: 57.69, v: 2.18, m: 25, L_override: "", K_override: "" },
      { sku: "SKU06", mu: 316.3636364, sigma: 79.09, c: 3.56,  h: 0.64, p: 10.68, v: 2.92, m: 25, L_override: "", K_override: "" },
      { sku: "SKU07", mu: 363.6363636, sigma: 90.91, c: 25.48, h: 4.59, p: 76.44, v: 0.79, m: 25, L_override: "", K_override: "" },
      { sku: "SKU08", mu: 410.9090909, sigma: 102.73,c: 7.91,  h: 1.42, p: 23.73, v: 0.71, m: 25, L_override: "", K_override: "" },
      { sku: "SKU09", mu: 458.1818182, sigma: 114.55,c: 11.21, h: 2.02, p: 33.63, v: 1.67, m: 25, L_override: "", K_override: "" },
      { sku: "SKU10", mu: 505.4545455, sigma: 126.36,c: 14.66, h: 2.64, p: 43.98, v: 1.02, m: 25, L_override: "", K_override: "" },
      { sku: "SKU11", mu: 552.7272727, sigma: 138.18,c: 19.52, h: 3.51, p: 58.56, v: 0.59, m: 25, L_override: "", K_override: "" },
      { sku: "SKU12", mu: 600,        sigma: 150,   c: 10.89, h: 1.96, p: 32.67, v: 1.23, m: 25, L_override: "", K_override: "" }
    ];

    /***********************
     * 2. Math helpers
     ***********************/

    const SQRT2PI = Math.sqrt(2 * Math.PI);

    function normalPdf(z) {
      return Math.exp(-0.5 * z * z) / SQRT2PI;
    }

    // Approximate standard normal CDF (Abramowitz & Stegun 7.1.26)
    function normalCdf(z) {
      const sign = z < 0 ? -1 : 1;
      const x = Math.abs(z) / Math.SQRT2;
      const t = 1 / (1 + 0.3275911 * x);
      const a1 = 0.254829592;
      const a2 = -0.284496736;
      const a3 = 1.421413741;
      const a4 = -1.453152027;
      const a5 = 1.061405429;
      const erf = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
      const res = 0.5 * (1 + sign * erf);
      return res;
    }

    // Approximate inverse standard normal CDF (Acklam's approximation)
    function normalInv(p) {
      if (p <= 0 || p >= 1) {
        throw new Error("p must be in (0,1)");
      }
      const a = [
        -3.969683028665376e+1,
         2.209460984245205e+2,
        -2.759285104469687e+2,
         1.383577518672690e+2,
        -3.066479806614716e+1,
         2.506628277459239e+0
      ];
      const b = [
        -5.447609879822406e+1,
         1.615858368580409e+2,
        -1.556989798598866e+2,
         6.680131188771972e+1,
        -1.328068155288572e+1
      ];
      const c = [
        -7.784894002430293e-3,
        -3.223964580411365e-1,
        -2.400758277161838e+0,
        -2.549732539343734e+0,
         4.374664141464968e+0,
         2.938163982698783e+0
      ];
      const d = [
         7.784695709041462e-3,
         3.224671290700398e-1,
         2.445134137142996e+0,
         3.754408661907416e+0
      ];
      const plow  = 0.02425;
      const phigh = 1 - plow;
      let q, r;

      if (p < plow) {
        // lower tail
        q = Math.sqrt(-2 * Math.log(p));
        return (((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]) /
               ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
      } else if (phigh < p) {
        // upper tail
        q = Math.sqrt(-2 * Math.log(1 - p));
        return -(((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]) /
                 ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
      } else {
        // central region
        q = p - 0.5;
        r = q * q;
        return (((((a[0]*r + a[1])*r + a[2])*r + a[3])*r + a[4])*r + a[5]) * q /
               (((((b[0]*r + b[1])*r + b[2])*r + b[3])*r + b[4])*r + 1);
      }
    }

    function ceilToInt(x) {
      return Math.ceil(x);
    }

    /***********************
     * 3. Render inputs
     ***********************/

    function renderParams() {
      const container = document.getElementById("params-container");
      container.innerHTML = "";
      initialParams.forEach(p => {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "0.5rem";
        wrapper.innerHTML = `
          <label for="param-${p.id}">${p.label}</label>
          <input type="number" step="any" id="param-${p.id}" value="${p.value}">
        `;
        container.appendChild(wrapper);
      });
    }

    function renderInputsTable() {
      const table = document.getElementById("inputs-table");
      const headers = [
        "SKU","Œº","œÉ","c","h","p","v","m","L override","K override"
      ];
      let html = "<thead><tr>";
      headers.forEach(h => {
        html += `<th>${h}</th>`;
      });
      html += "</tr></thead><tbody>";

      skuInputs.forEach((row, idx) => {
        html += `<tr data-idx="${idx}">`;
        html += `<td>${row.sku}</td>`;
        html += `<td><input type="number" step="any" value="${row.mu}" data-field="mu"></td>`;
        html += `<td><input type="number" step="any" value="${row.sigma}" data-field="sigma"></td>`;
        html += `<td><input type="number" step="any" value="${row.c}" data-field="c"></td>`;
        html += `<td><input type="number" step="any" value="${row.h}" data-field="h"></td>`;
        html += `<td><input type="number" step="any" value="${row.p}" data-field="p"></td>`;
        html += `<td><input type="number" step="any" value="${row.v}" data-field="v"></td>`;
        html += `<td><input type="number" step="any" value="${row.m}" data-field="m"></td>`;
        html += `<td><input type="number" step="any" value="${row.L_override}" data-field="L_override"></td>`;
        html += `<td><input type="number" step="any" value="${row.K_override}" data-field="K_override"></td>`;
        html += `</tr>`;
      });

      html += "</tbody>";
      table.innerHTML = html;

      // attach change handlers
      table.querySelectorAll("tbody tr").forEach(tr => {
        const idx = parseInt(tr.getAttribute("data-idx"), 10);
        tr.querySelectorAll("input").forEach(input => {
          input.addEventListener("input", () => {
            const field = input.getAttribute("data-field");
            let val = input.value;
            if (val === "") {
              skuInputs[idx][field] = "";
            } else {
              skuInputs[idx][field] = Number(val);
            }
          });
        });
      });
    }

    /***********************
     * 4. Calculation logic
     ***********************/

    function getParamValue(id) {
      const el = document.getElementById("param-" + id);
      return Number(el.value);
    }

    function computeAll() {
      const L     = getParamValue("L");
      const K     = getParamValue("K");
      const sigmaLParam = getParamValue("sigmaL");
      const Lr    = getParamValue("Lr");
      const kanbanSafety = getParamValue("kanbanSafety");
      const spaceCapacity = getParamValue("spaceCapacity");

      const rows = [];
      let totalOrdering = 0;
      let totalHolding  = 0;
      let totalShortage = 0;
      let totalCost     = 0;
      let totalInvValue = 0;
      let totalVolume   = 0;
      let demandWeightedFillNumer = 0;
      let demandWeightedFillDenom = 0;

      skuInputs.forEach(row => {
        const mu = Number(row.mu);
        const sigma = Number(row.sigma);
        const c = Number(row.c);
        const h = Number(row.h);
        const p = Number(row.p);
        const v = Number(row.v);
        const m = Number(row.m);

        const L_eff = row.L_override === "" ? L : Number(row.L_override);
        const K_eff = row.K_override === "" ? K : Number(row.K_override);

        if (!mu || !sigma || !h || !p || !v || !m || !L_eff || !K_eff) {
          // Skip weird/incomplete rows
          return;
        }

        const serviceFractile = p / (p + h);
        const z = normalInv(serviceFractile);
        const mu_L = mu * L_eff;
        const sigma_L = Math.sqrt(
          sigma * sigma * L_eff + mu * mu * sigmaLParam * sigmaLParam
        );
        const safetyStock = z * sigma_L;
        const ROP = mu_L + safetyStock;

        const EOQ = Math.sqrt(2 * K_eff * mu / h);
        const cycleStock = EOQ / 2;

        const phi = normalPdf(z);
        const Phi = normalCdf(z);
        const lossLz = phi - z * (1 - Phi);
        const expectedBackorders = sigma_L * lossLz;
        const avgOnHand = Math.max(0, safetyStock + cycleStock - expectedBackorders);

        const orderingCostPerWeek = (K_eff * mu) / EOQ;
        const holdingCostPerWeek  = h * avgOnHand;
        const shortageCostPerWeek = p * expectedBackorders * (mu / EOQ);
        const totalCostPerWeek    = orderingCostPerWeek + holdingCostPerWeek + shortageCostPerWeek;

        const inventoryValuePerWeek = c * avgOnHand;
        const avgVolume             = v * avgOnHand;
        const fillRate              = Math.max(0, Math.min(1, 1 - expectedBackorders / EOQ));

        const kanbanCards = ceilToInt(
          (mu * Lr * (1 + kanbanSafety)) / m
        );

        rows.push({
          sku: row.sku,
          mu,
          sigma,
          c,
          h,
          p,
          v,
          m,
          L_eff,
          K_eff,
          serviceFractile,
          z,
          mu_L,
          sigma_L,
          safetyStock,
          ROP,
          EOQ,
          cycleStock,
          phi,
          Phi,
          lossLz,
          expectedBackorders,
          avgOnHand,
          orderingCostPerWeek,
          holdingCostPerWeek,
          shortageCostPerWeek,
          totalCostPerWeek,
          inventoryValuePerWeek,
          avgVolume,
          fillRate,
          kanbanCards
        });

        totalOrdering += orderingCostPerWeek;
        totalHolding  += holdingCostPerWeek;
        totalShortage += shortageCostPerWeek;
        totalCost     += totalCostPerWeek;
        totalInvValue += inventoryValuePerWeek;
        totalVolume   += avgVolume;

        demandWeightedFillNumer += mu * fillRate;
        demandWeightedFillDenom += mu;
      });

      const capacityUtilization = spaceCapacity ? totalVolume / spaceCapacity : 0;
      const demandWeightedFillRate = demandWeightedFillDenom
        ? demandWeightedFillNumer / demandWeightedFillDenom
        : 0;

      return {
        rows,
        kpis: {
          totalOrdering,
          totalHolding,
          totalShortage,
          totalCost,
          totalInvValue,
          totalVolume,
          spaceCapacity,
          capacityUtilization,
          demandWeightedFillRate
        }
      };
    }

    /***********************
     * 5. Render outputs
     ***********************/

    function renderCalcsTable(rows) {
      const table = document.getElementById("calcs-table");
      if (!rows || rows.length === 0) {
        table.innerHTML = "<tbody><tr><td>No rows (check inputs).</td></tr></tbody>";
        return;
      }

      const headers = [
        "SKU","Œº","œÉ","L_eff","K_eff",
        "Service Œ±","z","Œº_L","œÉ_L","SS",
        "ROP","EOQ","Cycle","EBO","Avg On-hand",
        "Order Cost/wk","Hold Cost/wk","Short Cost/wk",
        "Total Cost/wk","Inv Value/wk","Avg Volume","Fill Rate","Kanban Cards"
      ];

      let html = "<thead><tr>";
      headers.forEach(h => { html += `<th>${h}</th>`; });
      html += "</tr></thead><tbody>";

      rows.forEach(r => {
        const fmt = (x, d=2) => x.toFixed(d);
        html += "<tr>";
        html += `<td>${r.sku}</td>`;
        html += `<td>${fmt(r.mu)}</td>`;
        html += `<td>${fmt(r.sigma)}</td>`;
        html += `<td>${fmt(r.L_eff, 2)}</td>`;
        html += `<td>${fmt(r.K_eff, 2)}</td>`;
        html += `<td>${fmt(r.serviceFractile, 3)}</td>`;
        html += `<td>${fmt(r.z, 3)}</td>`;
        html += `<td>${fmt(r.mu_L, 2)}</td>`;
        html += `<td>${fmt(r.sigma_L, 2)}</td>`;
        html += `<td>${fmt(r.safetyStock, 2)}</td>`;
        html += `<td>${fmt(r.ROP, 2)}</td>`;
        html += `<td>${fmt(r.EOQ, 2)}</td>`;
        html += `<td>${fmt(r.cycleStock, 2)}</td>`;
        html += `<td>${fmt(r.expectedBackorders, 2)}</td>`;
        html += `<td>${fmt(r.avgOnHand, 2)}</td>`;
        html += `<td>${fmt(r.orderingCostPerWeek, 2)}</td>`;
        html += `<td>${fmt(r.holdingCostPerWeek, 2)}</td>`;
        html += `<td>${fmt(r.shortageCostPerWeek, 2)}</td>`;
        html += `<td>${fmt(r.totalCostPerWeek, 2)}</td>`;
        html += `<td>${fmt(r.inventoryValuePerWeek, 2)}</td>`;
        html += `<td>${fmt(r.avgVolume, 2)}</td>`;
        html += `<td>${fmt(r.fillRate, 3)}</td>`;
        html += `<td>${r.kanbanCards}</td>`;
        html += "</tr>";
      });

      html += "</tbody>";
      table.innerHTML = html;
    }

    function renderKpis(kpis) {
      const wrap = document.getElementById("kpis-container");
      const fmt = (x, d=2) => x.toFixed(d);

      wrap.innerHTML = `
        <div class="kpi-row">
          <span class="kpi-label">Total Ordering Cost (per week)</span>
          <span class="kpi-value">${fmt(kpis.totalOrdering)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Total Holding Cost (per week)</span>
          <span class="kpi-value">${fmt(kpis.totalHolding)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Total Shortage Cost (per week)</span>
          <span class="kpi-value">${fmt(kpis.totalShortage)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Total Cost (per week)</span>
          <span class="kpi-value">${fmt(kpis.totalCost)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Total Inventory Value (per week)</span>
          <span class="kpi-value">${fmt(kpis.totalInvValue)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Total Avg Volume (space units)</span>
          <span class="kpi-value">${fmt(kpis.totalVolume)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Capacity (Params)</span>
          <span class="kpi-value">${fmt(kpis.spaceCapacity)}</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Capacity Utilization</span>
          <span class="kpi-value">${fmt(kpis.capacityUtilization * 100)}%</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-label">Demand-weighted Fill Rate</span>
          <span class="kpi-value">${fmt(kpis.demandWeightedFillRate * 100)}%</span>
        </div>
      `;
    }

    /***********************
     * 6. Wiring it up
     ***********************/

    function recalcAndRender() {
      try {
        const { rows, kpis } = computeAll();
        renderCalcsTable(rows);
        renderKpis(kpis);
      } catch (e) {
        alert("Error during calculation: " + e.message);
      }
    }

    // Initial render
    renderParams();
    renderInputsTable();
    recalcAndRender();

    document.getElementById("recalc-btn").addEventListener("click", recalcAndRender);
  </script>
</body>
</html>
